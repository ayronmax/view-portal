CREATE OR REPLACE PROCEDURE SP_BOLETIM( IN CODIGO_VENDEDOR CHAR(03),
										IN CODIGO_CLIENTE INT,
										IN CONDICAO_PAGAMENTO INT, 
										IN TIPO_COBRANCA INT,
										IN TIPO_TEC_LOCALIZA CHAR(001),
										IN MOTIVO_NAO_COMPRA CHAR(001) , 
										IN PEDIDO_TRANSMITIDO CHAR(001),
										IN VALOR_PEDIDO DECIMAL(08,2),										
										IN hora_inicial INT,
										IN hora_final INT,
										IN CORDENADA_PEDIDO_X FLOAT,
										IN CORDENADA_PEDIDO_Y FLOAT,
										IN COD_EMP INT
										)

LANGUAGE SQL

BEGIN

    DECLARE RAZAO_CLIENTE VARCHAR(050);	
	DECLARE REGIAO_CLIENTE INT;
	DECLARE NUMERO_CLIENTE INT;	
	DECLARE CONDICAO_PAGAMENTO_DESC VARCHAR(020);
	DECLARE PASTA INT;
	DECLARE VALOR DECIMAL(8,2);
	declare HORAS_EM_SEGUNDO float;
    declare DIF_HORA float;
    declare DIF_MIN  float;
    declare DIF_SEC  float;
	DECLARE CORDENADA_X_CIMA FLOAT;
	DECLARE CORDENADA_Y_CIMA FLOAT;
	DECLARE CORDENADA_X_BAIXO FLOAT;
	DECLARE CORDENADA_Y_BAIXO FLOAT;
	DECLARE CORDENADA_X_CLIENTE FLOAT;
	DECLARE CORDENADA_Y_CLIENTE FLOAT;
	DECLARE CORDENADA_MARGEM FLOAT;
	DECLARE ROTA CHAR(001);
	

    SET CORDENADA_X_CLIENTE = SELECT VDCLICLI_XEWCOO  FROM CADCLI61 
	                                             WHERE VDCLICLI_REGI = REGIAO_CLIENTE AND VDCLICLI_NUM = NUMERO_CLIENTE ;
												 
    SET CORDENADA_Y_CLIENTE = SELECT VDCLICLI_YNSCOO  FROM CADCLI61 
	                                             WHERE VDCLICLI_REGI = REGIAO_CLIENTE AND VDCLICLI_NUM = NUMERO_CLIENTE ;	
	
	
    SET CORDENADA_MARGEM = SELECT VDPAROCO_MAGEM_GPS FROM PAROCO61 WHERE VDPAROCO_CODEMP = COD_EMP;
	
	IF CORDENADA_MARGEM <> NULL THEN 
      SET CORDENADA_X_CIMA  = CORDENADA_X_CLIENTE + CORDENADA_MARGEM;
      SET CORDENADA_Y_CIMA  = CORDENADA_Y_CLIENTE + CORDENADA_MARGEM;
      SET CORDENADA_X_BAIXO = CORDENADA_X_CLIENTE - CORDENADA_MARGEM;
      SET CORDENADA_Y_BAIXO = CORDENADA_Y_CLIENTE - CORDENADA_MARGEM;
	  
	  IF CORDENADA_PEDIDO_X > CORDENADA_X_CIMA  OR 
	     CORDENADA_PEDIDO_X < CORDENADA_X_BAIXO OR 
		 CORDENADA_PEDIDO_Y > CORDENADA_Y_CIMA  OR 
	     CORDENADA_PEDIDO_Y < CORDENADA_Y_BAIXO THEN  
		 SET ROTA = 'F'; 
	  ELSE 
         SET ROTA = ''; 
	  END IF;
	END IF;
   
	SET REGIAO_CLIENTE = CAST(LEFT(REPEAT('0',  8 - LENGTH(CAST(CODIGO_CLIENTE AS VARCHAR(008))))||CAST(CODIGO_CLIENTE AS VARCHAR(008)),4) AS INT) ;	
	SET NUMERO_CLIENTE = CAST(RIGHT(REPEAT('0',  8 - LENGTH(CAST(CODIGO_CLIENTE AS VARCHAR(008))))||CAST(CODIGO_CLIENTE AS VARCHAR(008)),4) AS INT);
	
													 
	
	
	SET RAZAO_CLIENTE = SELECT VDCLICLI_RAZAO50  FROM CADCLI61 
	                                             WHERE VDCLICLI_REGI = REGIAO_CLIENTE AND VDCLICLI_NUM = NUMERO_CLIENTE ;
    SET RAZAO_CLIENTE = SELECT VDCLICLI_RAZAO50  FROM CADCLI61 
	                                             WHERE VDCLICLI_REGI = REGIAO_CLIENTE AND VDCLICLI_NUM = NUMERO_CLIENTE ;
    SET CONDICAO_PAGAMENTO_DESC = SELECT VDCADPAG_DESCR FROM CONDPG61 WHERE VDCADPAG_COD = CONDICAO_PAGAMENTO;
	
	SET PASTA = SELECT VDCLICLI_SEQPASTA1 FROM CADCLI61 WHERE  VDCLICLI_VEN = CODIGO_VENDEDOR AND 
                                                        VDCLICLI_REGI = REGIAO_CLIENTE AND VDCLICLI_NUM = NUMERO_CLIENTE ;
	
	IF PASTA IS NULL THEN
		SET PASTA = SELECT VDCLICLI_SEQPASTA2 FROM CADCLI61 WHERE  VDCLICLI_VEN2 = CODIGO_VENDEDOR AND VDCLICLI_NUM = NUMERO_CLIENTE AND VDCLICLI_REGI = REGIAO_CLIENTE ;
		IF PASTA IS NULL THEN 
			SET PASTA = SELECT VDCLICLI_SEQPASTA3 FROM CADCLI61 WHERE  VDCLICLI_VEN3 = CODIGO_VENDEDOR AND VDCLICLI_NUM = NUMERO_CLIENTE AND VDCLICLI_REGI = REGIAO_CLIENTE ;
			IF PASTA IS NULL THEN 
				SET PASTA = SELECT VDCLICLI_SEQPASTA4 FROM CADCLI61 WHERE  VDCLICLI_VEN4 = CODIGO_VENDEDOR AND VDCLICLI_NUM = NUMERO_CLIENTE AND VDCLICLI_REGI = REGIAO_CLIENTE ;
				IF PASTA IS NULL THEN 
					SET PASTA = SELECT VDCLICLI_SEQPASTA5 FROM CADCLI61 WHERE  VDCLICLI_VEN5 = CODIGO_VENDEDOR AND VDCLICLI_NUM = NUMERO_CLIENTE AND VDCLICLI_REGI = REGIAO_CLIENTE ;					
				END IF;
		    END IF;
		END IF;
    END IF;	
	
	
	IF MOTIVO_NAO_COMPRA = 'S'   OR 
	   MOTIVO_NAO_COMPRA IS NULL OR
	   MOTIVO_NAO_COMPRA = '0'   OR 
       MOTIVO_NAO_COMPRA = '00'  OR 
	   MOTIVO_NAO_COMPRA = '000' THEN 
	     SET VALOR = VALOR_PEDIDO;
	ELSE 
	     SET VALOR = 0;
	END IF;
	
	
	 set HORAS_EM_SEGUNDO =   
					( (cast(substring(Cast(hora_inicial as char(006)), 1,2) as int) * 3600) + 
					 (cast(substring(Cast(hora_inicial as char(006)), 3,2) as int) * 60) +
					 cast(substring(Cast(hora_inicial as char(006)), 5,2) as int) )
					 -
					 ( (cast(substring(Cast(hora_final as char(006)), 1,2) as int) * 3600) 
					 + (cast(substring(Cast(hora_final as char(006)), 3,2) as int) * 60) +
					 cast(substring(Cast(hora_final as char(006)), 5,2) as int) ) ;


	SET DIF_HORA =  HORAS_EM_SEGUNDO / 3600 ;	
	
	SET DIF_MIN =  abs((HORAS_EM_SEGUNDO - (CAST(LEFT(CAST(DIF_HORA AS VARCHAR(255)), locate('.', CAST(DIF_HORA AS VARCHAR(255)), 1)) AS INT) * 3600)) / 60) ;


	SET DIF_SEC =  ABS(DIF_MIN - (CAST(LEFT(CAST(DIF_HORA AS VARCHAR(255)), locate('.', CAST(DIF_HORA AS VARCHAR(255)), 1)) AS INT )* 60));
	
	
	INSERT INTO BOLETI61 ( VDPTCBOL_TP_DIG, 
	                       VDPTCBOL_VEN,
   						   VDPTCBOL_DATA, 
						   VDPTCBOL_PAG,
						   VDPTCBOL_DET,
						   VDPTCBOL_CODCLI,
                           VDPTCBOL_SEQ, 
						   VDPTCBOL_COD_CPG,
						   VDPTCBOL_CPG,
						   VDPTCBOL_RAZAO,
						   VDPTCBOL_TPCOBR,
						   VDPTCBOL_SEQV,
						   VDPTCBOL_FLAGROTA,
						   VDPTCBOL_TEC_LOCALIZA, 
						   VDPTCBOL_MNCOMPRA,
						   VDPTCBOL_PED_TRANSMITIDO,
						   VDPTCBOL_VISITADO,
						   VDPTCBOL_VALOR,
						   VDPTCBOL_HH_VIS_INI,
						   VDPTCBOL_MM_VIS_INI,
						   VDPTCBOL_SS_VIS_INI,
						   VDPTCBOL_HH_VIS_FIM,
						   VDPTCBOL_MM_VIS_FIM,
						   VDPTCBOL_SS_VIS_FIM,
						   VDPTCBOL_HH_DURACAO,
                           VDPTCBOL_MM_DURACAO,
                           VDPTCBOL_SS_DURACAO,
						   VDPTCBOL_HH_PERC, 
                           VDPTCBOL_MM_PERC,
                           VDPTCBOL_SS_PERC,
                           VDPTCBOL_FLAG_TEMPO,
						   VDPTCBOL_HH_TEMPO,
                           VDPTCBOL_MM_TEMPO,
                           VDPTCBOL_SS_TEMPO,
						   VDPTCBOL_HH_VIS_INI,
                           VDPTCBOL_MM_VIS_INI,
                           VDPTCBOL_SS_VIS_INI,
						   VDPTCBOL_HH_VIS_FIM, 
                           VDPTCBOL_MM_VIS_FIM,  
                           VDPTCBOL_SS_VIS_FIM,
						   VDPTCBOL_GPS
						   ) 
	VALUES (0,
          	CODIGO_VENDEDOR,
			cast(DATETOSTR(Curdate(), 'yyyymmdd') as int),
			1,
			1,
			CODIGO_CLIENTE,
			1, 
			CONDICAO_PAGAMENTO,
			CONDICAO_PAGAMENTO_DESC,
			RAZAO_CLIENTE,	
            TIPO_COBRANCA,
			PASTA,
			'',
			TIPO_TEC_LOCALIZA,
			MOTIVO_NAO_COMPRA,
			PEDIDO_TRANSMITIDO,
			"S",
			VALOR,
			DIF_HORA,
			DIF_MIN,
			DIF_SEC,
			DIF_HORA,
			DIF_MIN,
			DIF_SEC,
			DIF_HORA,
			DIF_MIN,
			DIF_SEC,
			DIF_HORA,
			DIF_MIN,
			DIF_SEC,
            '',		
			DIF_HORA,
			DIF_MIN,
			DIF_SEC,
            cast(substring(Cast(hora_inicial as char(006)), 1,2) as int),
            cast(substring(Cast(hora_inicial as char(006)), 3,2) as int),
            cast(substring(Cast(hora_inicial as char(006)), 5,2) as int),			
			cast(substring(Cast( hora_final  as char(006)), 1,2) as int),
            cast(substring(Cast( hora_final  as char(006)), 3,2) as int),
            cast(substring(Cast( hora_final  as char(006)), 5,2) as int),	
			ROTA			
			);

END;

